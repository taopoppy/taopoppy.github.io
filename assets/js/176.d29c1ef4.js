(window.webpackJsonp=window.webpackJsonp||[]).push([[176],{360:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"实战页面-下载页"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实战页面-下载页","aria-hidden":"true"}},[t._v("#")]),t._v(" 实战页面 - 下载页")]),t._v(" "),a("h2",{attrs:{id:"页面架构分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#页面架构分析","aria-hidden":"true"}},[t._v("#")]),t._v(" 页面架构分析")]),t._v(" "),a("p",[t._v("实际对于一个项目的架构设计，可以从消息发送的路径走向，或者按照协议的路径进行设计，我们首先来设计一下下载页的架构，因为下载页是一个静态的网页，基本上就是一个浏览器和"),a("code",[t._v("Node-bff")]),t._v("层的交互：")]),t._v(" "),a("img",{attrs:{src:t.$withBase("/node_bff_xiazaiye_jiagoutu.png"),alt:"下载页的架构图"}}),t._v(" "),a("ul",[a("li",[a("p",[t._v("浏览器和"),a("code",[t._v("Node-BFF")]),t._v("层建立TCP链接，发送"),a("code",[t._v("http")]),t._v("数据包")])]),t._v(" "),a("li",[a("p",[a("code",[t._v("Node-BFF")]),t._v("层的路由判断"),a("code",[t._v("http")]),t._v("数据包中的请求"),a("code",[t._v("url")]),t._v(",将数据包转发到负责下载页的逻辑单元去")])]),t._v(" "),a("li",[a("p",[t._v("下载页的逻辑单元判断这个是静态页面，所以从"),a("code",[t._v("Node-BFF")]),t._v("层所在的这个机器上面使用"),a("code",[t._v("fs")]),t._v("模块读取静态页面并通过路由返回给浏览器（"),a("font",{attrs:{color:"#DD1144"}},[t._v("以上三步在上图由红色直线标注")]),t._v("）")],1)]),t._v(" "),a("li",[a("p",[t._v("然后浏览器拿到这个页面，页面渲染才刚刚开始")])]),t._v(" "),a("li",[a("p",[t._v("在静态页面当中有很多"),a("code",[t._v("css")]),t._v("或者"),a("code",[t._v("javascript")]),t._v("标签标注的文件，那么这些都属于一个个"),a("code",[t._v("http")]),t._v("链接")])]),t._v(" "),a("li",[a("p",[t._v("比如某个"),a("code",[t._v("css")]),t._v("文件在当前域名下面某个文件中，那么浏览器依旧要请求到"),a("code",[t._v("Node-BFF")]),t._v("层中")])]),t._v(" "),a("li",[a("p",[t._v("那么下载页的逻辑单元拿到这个请求发现这个是个静态资源的请求，那么会转发到另外一个专门处理"),a("code",[t._v("css")]),t._v("和"),a("code",[t._v("js")]),t._v("脚本的处理逻辑单元")])]),t._v(" "),a("li",[a("p",[t._v("这个专门处理"),a("code",[t._v("css")]),t._v("和"),a("code",[t._v("js")]),t._v("的逻辑单元把静态文件返回给下载页的处理逻辑单元，再返回给路由，再返回给浏览器")])]),t._v(" "),a("li",[a("p",[t._v("浏览器拿到这些静态"),a("code",[t._v("css")]),t._v("文件和"),a("code",[t._v("js")]),t._v("脚本文件才开始渲染（"),a("font",{attrs:{color:"#3eaf7c"}},[t._v("以上六步在上图由绿色直线标注")]),t._v("）")],1)])]),t._v(" "),a("h2",{attrs:{id:"下载页的开发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下载页的开发","aria-hidden":"true"}},[t._v("#")]),t._v(" 下载页的开发")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" koa "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa-mount'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa-static'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("koa")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__dirname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/source/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__dirname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/source/index.html'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf-8'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("可以看的出，下载页的开发很简单，几个中间件的使用我们在这里也不做太多的解释。")]),t._v(" "),a("p",[t._v("当我们写好的时候，我们访问的时候访问的"),a("code",[t._v("URL")]),t._v("如下："),a("code",[t._v("localhost:3000/download/")]),t._v("（如果少了最后一个反斜杠，访问"),a("code",[t._v("localhost:3000/download")]),t._v("，就会造成css加载不成功的结果）\n这里我们来把后面几个页面的访问地址都放在这里：")]),t._v(" "),a("ul",[a("li",[a("font",{attrs:{color:"#3eaf7c"}},[t._v("http://localhost:3000/download/")])],1),t._v(" "),a("li",[a("font",{attrs:{color:"#3eaf7c"}},[t._v("http://localhost:3000/detail/?columnid=1")])],1),t._v(" "),a("li",[a("font",{attrs:{color:"#3eaf7c"}},[t._v("http://localhost:3000/play/")])],1),t._v(" "),a("li",[a("font",{attrs:{color:"#3eaf7c"}},[t._v("http://localhost:3000/list/")])],1)]),t._v(" "),a("p",[t._v("所有实战的项目的源码地址："),a("a",{attrs:{href:"https://github.com/geektime-geekbang/geek-nodejs/tree/master/chapter3",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/geektime-geekbang/geek-nodejs/tree/master/chapter3"),a("OutboundLink")],1)])])},[],!1,null,null,null);s.default=e.exports}}]);