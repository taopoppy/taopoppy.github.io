(window.webpackJsonp=window.webpackJsonp||[]).push([[172],{357:function(t,s,a){"use strict";a.r(s);var n=a(0),r=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"性能工具-实际代码优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#性能工具-实际代码优化","aria-hidden":"true"}},[t._v("#")]),t._v(" 性能工具 - 实际代码优化")]),t._v(" "),a("h2",{attrs:{id:"优化分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优化分析","aria-hidden":"true"}},[t._v("#")]),t._v(" 优化分析")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__dirname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/source/index.html'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf-8'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("针对我们原来的代码，我们进行"),a("code",[t._v("localhost:3000/download/")]),t._v("进行测试，结果如下")]),t._v(" "),a("img",{attrs:{src:t.$withBase("/node_bff_youhua_reasult1.png"),alt:"分析结果"}}),t._v(" "),a("img",{attrs:{src:t.$withBase("/node_bff_youhua_result2.png"),alt:"分析结果"}}),t._v(" "),a("p",[t._v("从上面的"),a("code",[t._v("cpu")]),t._v("结果看，我们原有的代码有两个大的问题，")]),t._v(" "),a("ul",[a("li",[t._v("第一所有用户进来都要重新读取"),a("code",[t._v("html")]),t._v("文件，因为这里是下载页，无论谁来访问都是这个页面，所以其实我们可以把读取的结果拉到外面去，让它在程序启动的时候就读取出来，每个用户进来只需要拿结果，不需要每个人访问都要重新读取")]),t._v(" "),a("li",[t._v("第二就是关于"),a("code",[t._v("buffer")]),t._v("的操作很频繁，我们来思考一下，因为"),a("code",[t._v("Node")]),t._v("底层是"),a("code",[t._v("C++")]),t._v("，所以即使你给"),a("code",[t._v("http")]),t._v("的"),a("code",[t._v("body")]),t._v("赋值了一个字符串，在"),a("code",[t._v("Node")]),t._v("运行的时候还是要转化成为"),a("code",[t._v("Buffer")]),t._v("才能输出出去，因为要转化成为"),a("code",[t._v("C++")]),t._v("认识的结构。所以我们通过文件读取出来的是字符串，字符串还要转化成为"),a("code",[t._v("buffer")]),t._v("，我们直接读取"),a("code",[t._v("buffer")]),t._v("不就完事了，而且"),a("code",[t._v("fs.readFile")]),t._v("读取的本身就是"),a("code",[t._v("Buffer")]),t._v("，所以我们原有的代码就是多此一举。")])]),t._v(" "),a("p",[t._v("所以我们修改代码如下：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" buffer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__dirname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/source/index.html'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'html'")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" buffer\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("我们这里做的就是把读取同一个文件的操作拿了出去，然后主动告诉"),a("code",[t._v("ctx.type")]),t._v("的返回类型，因为"),a("code",[t._v("koa")]),t._v("识别到我们返回的是"),a("code",[t._v("buffer")]),t._v("可能会执行下载操作。所以这样优化之后我们的"),a("code",[t._v("qps")]),t._v("还有吞吐量都会上去，因为每个用户不用去执行读取文件的操作，只需要拿结果就好。")]),t._v(" "),a("h2",{attrs:{id:"内存管理优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#内存管理优化","aria-hidden":"true"}},[t._v("#")]),t._v(" 内存管理优化")]),t._v(" "),a("p",[t._v("这里我们先简单介绍一下垃圾回收，因为"),a("code",[t._v("GC")]),t._v("和"),a("code",[t._v("V8")]),t._v("的联系紧密，如果想深度了解垃圾回收和"),a("code",[t._v("V8")]),t._v("的机制，建议到"),a("a",{attrs:{href:"https://www.taopoppy.cn/node/two_module_v8.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("核心模块 - v8"),a("OutboundLink")],1),t._v("去研究一下。")]),t._v(" "),a("p",[a("code",[t._v("js")]),t._v("引擎会记录所有我们创建的"),a("code",[t._v("javascript")]),t._v("对象，隔一段时间就会去定时清理没有再被使用的"),a("code",[t._v("javascript")]),t._v("对象。每一个"),a("code",[t._v("javascript")]),t._v("引擎的垃圾回收机制都是不一样的，我们这里就以"),a("code",[t._v("V8")]),t._v("为例，它会把堆内存分为"),a("font",{attrs:{color:"#DD1144"}},[t._v("新生代")]),t._v("和"),a("font",{attrs:{color:"#DD1144"}},[t._v("老生代")]),t._v("，新创建的"),a("code",[t._v("javascript")]),t._v("变量都会先分配到新生代当中，等新生代快要满的时候就会执行快速的垃圾回收，腾出空间给新的"),a("code",[t._v("javascript")]),t._v("对象使用，如果经过几轮的快速的垃圾回收，有些"),a("code",[t._v("javascript")]),t._v("变量都没有被清理，它就会进入老生代区域，老生代的内存更大，垃圾清理的频率会更低。整个这个过程就是简单的"),a("code",[t._v("V8")]),t._v("垃圾回收机制。")],1),t._v(" "),a("p",[t._v("那么对我们优化来说有什么作用呢，其实不管新生代还是老生代，都满足一个规律就是："),a("font",{attrs:{color:"#1E90FF"}},[t._v("放在里面的内存越少，垃圾回收的速度就越快")]),t._v("，所以我们要注意减少内存的使用，另外内存泄漏也是关键的地方，"),a("font",{attrs:{color:"#1E90FF"}},[t._v("因为内存一旦泄露，就会长期处于老生代，然后老生代的垃圾回收每次都要遍历这段泄露的大内存，导致垃圾回收的速度减慢。")]),t._v(",我们下面来研究一个内存泄漏的情况：")],1),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" buffer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__dirname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/source/index.htm'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'html'")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" buffer\n    leak"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" leak "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("上述代码，我们看到用户的每次请求的字符串都被保存在一个"),a("code",[t._v("leak")]),t._v("的数组当中，然后我们来用"),a("code",[t._v("ab")]),t._v("测试一下，采用上一小节的那个内存检测的方法来进行检测，我们快照了程序运行中的内存和程序结束后的内存，然后进行比较")]),t._v(" "),a("img",{attrs:{src:t.$withBase("/node_bff_ab_memory.png"),alt:"内存检测"}}),t._v(" "),a("p",[t._v("可以看到在"),a("code",[t._v("Profiles")]),t._v("当中，快照1是程序运行时的内存检测为208M，而到了程序结束就有1282M,这个显然有内存没有释放,接着看到在整个的"),a("code",[t._v("Constructor")]),t._v("当中，"),a("code",[t._v("(string)")]),t._v("的"),a("code",[t._v("Size Delta")]),t._v("相对于其他特别大，打开一看全是"),a("code",[t._v("html")]),t._v("文件的字符串，点击任意其中一个，看到在"),a("code",[t._v("Object")]),t._v("当中能够看到这些字符串的持有者为"),a("font",{attrs:{color:"#DD1144"}},[t._v("leak")]),t._v(",所以你到程序中一看，原来是"),a("code",[t._v("leak")]),t._v("数组没有被释放，这下你就知道内存的问题了")],1),t._v(" "),a("h2",{attrs:{id:"多进程优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#多进程优化","aria-hidden":"true"}},[t._v("#")]),t._v(" 多进程优化")]),t._v(" "),a("h3",{attrs:{id:"_1-node中的进程和线程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-node中的进程和线程","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. node中的进程和线程")]),t._v(" "),a("p",[t._v("在进行多进程优化之前，还是要明确一下进程和线程的概念")]),t._v(" "),a("ul",[a("li",[a("font",{attrs:{color:"#DD1144"}},[t._v("进程")]),t._v("（类似于公司）\n"),a("ul",[a("li",[t._v("操作系统挂载运行程序员的单元")]),t._v(" "),a("li",[t._v("拥有一些独立的资源，如内存等")])])],1),t._v(" "),a("li",[a("font",{attrs:{color:"#DD1144"}},[t._v("线程")]),t._v("（类似于职工）\n"),a("ul",[a("li",[t._v("进行运算调度的单元")]),t._v(" "),a("li",[t._v("进程内的线程共享进程内的资源")])])],1)]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("node")]),t._v("当中，和进程线程分不开的一个东西叫做事件循环，我们来讲一下两者的关系：")]),t._v(" "),a("ul",[a("li",[a("font",{attrs:{color:"#1E90FF"}},[t._v("主线程运行v8与javascript")])],1),t._v(" "),a("li",[a("font",{attrs:{color:"#1E90FF"}},[t._v("多个子线程(libuv提供)通过事件循环被调度")])],1)]),t._v(" "),a("p",[t._v("上述可能理解起来比较生涩，我们可以继续借用公司和员工的例子来理解："),a("font",{attrs:{color:"#1E90FF"}},[t._v("主线程相当于公司里面的的老板，其他子线程相当于公司职员，js主线程老板通过事件循环给其他线程员工分发任务")]),t._v("，但是虽然这样的机制已经很好了，但是保不齐老板的事情依旧很多，而且"),a("font",{attrs:{color:"#1E90FF"}},[t._v("js主线程只有一个线程，也只能用到cpu一个核")]),t._v("。所以这种情况还是会造成cpu的浪费，所以"),a("code",[t._v("node")]),t._v("提供了子进程和子线程，让其在别的"),a("code",[t._v("cpu")]),t._v("上也跑一个"),a("code",[t._v("javascript")]),t._v("环境，这种情况就相当于一个集团了。如图所示：\n"),a("img",{attrs:{src:t.$withBase("/node_bff_youhua_process.png"),alt:"多进程"}})],1),t._v(" "),a("h3",{attrs:{id:"_2-node中的子进程和子线程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-node中的子进程和子线程","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. node中的子进程和子线程")]),t._v(" "),a("p",[t._v("然后我们学习一下子进程的创建和使用：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// index.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" cp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'child_process'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建子进程，以child.js为入口文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" child_process "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" cp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__dirname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/child.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 父进程给子进程发送消息")]),t._v("\nchild_process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'haha'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 父进程监听子进程发来的消息 ")]),t._v("\nchild_process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'message'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'parent'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// child.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 子进程监听父进程发来的消息")]),t._v("\nprocess"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'message'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'child'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 子进程给父进程发送消息")]),t._v("\n\tprocess"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hehe'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("通过这样创建子进程的方式，"),a("code",[t._v("node")]),t._v("可以将一些任务进行分发到别的进程中去计算和实现，避免单个进程任务过多和"),a("code",[t._v("cpu")]),t._v("浪费的现象")]),t._v(" "),a("p",[t._v("子进程的概念也在"),a("code",[t._v("node")]),t._v("10版本后面提出来了，当你的程序需要很多的"),a("code",[t._v("cpu")]),t._v("计算，那么"),a("font",{attrs:{color:"#DD1144"}},[t._v("Worker Threads")]),t._v("是很有用的，但是实际上"),a("code",[t._v("node")]),t._v("当中的事件循环和非阻塞I/O已经能很好的解决并发问题了，而且子进程已经能够充分使用"),a("code",[t._v("cpu")]),t._v("了，除非你很明确的需要子线程，而不是子进程，那么"),a("code",[t._v("Worker Threads")]),t._v("就派上用场了。")],1),t._v(" "),a("h3",{attrs:{id:"_3-cluster模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-cluster模块","aria-hidden":"true"}},[t._v("#")]),t._v(" 3.cluster模块")]),t._v(" "),a("p",[a("code",[t._v("cluster")]),t._v("内置模块是"),a("code",[t._v("Node")]),t._v("官方特地为了网络服务而设计的，通过它我们可以快速的创建一个多核能力的网络服务程序。")]),t._v(" "),a("p",[t._v("我们在上面已经讲了子进程和父进程之间的通信能力很强大，那么能不能通过这种全面的通信能力来将"),a("code",[t._v("http")]),t._v("服务的能力分发出去？含义如下：\n"),a("img",{attrs:{src:t.$withBase("/node_bff_youhua_cluster.png"),alt:""}})]),t._v(" "),a("p",[t._v("正如上面图中所示，使用"),a("code",[t._v("cluster")]),t._v("内置模块可以很方便的来帮助我们进行多进程的优化，所以我们将在下一小节"),a("a",{attrs:{href:"https://www.taopoppy.cn/node-BFF/bff_three_optimization_cluster.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("cluster与进程守护管理"),a("OutboundLink")],1),t._v("当中使用"),a("code",[t._v("cluster")]),t._v("来实战一波。")]),t._v(" "),a("h2",{attrs:{id:"优化总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优化总结","aria-hidden":"true"}},[t._v("#")]),t._v(" 优化总结")]),t._v(" "),a("p",[a("font",{attrs:{color:"#1E90FF"}},[a("strong",[t._v("① 计算")])])],1),t._v(" "),a("ul",[a("li",[a("font",{attrs:{color:"#DD1144"}},[t._v("减少不必要的计算")]),t._v(" "),a("ul",[a("li",[t._v("比如前端优化我们会把小图合成大图，减少"),a("code",[t._v("http")]),t._v("页面总请求数量，减少"),a("code",[t._v("TCP")]),t._v("断链，"),a("code",[t._v("http")]),t._v("编解包和图片编解码的消耗")]),t._v(" "),a("li",[t._v("空间换时间（重复计算的结果进行缓存，直接使用计算结果）\n（"),a("font",{attrs:{color:"#1E90FF"}},[t._v("多以对于这条准则我们需要仔细的在整个http请求的过程中思考这个计算是不是必要，能不能拿到别的地方去计算")]),t._v("）")],1)])],1),t._v(" "),a("li",[a("font",{attrs:{color:"#DD1144"}},[t._v("提前计算")]),t._v(" "),a("ul",[a("li",[a("font",{attrs:{color:"#1E90FF"}},[t._v("尽量将服务阶段的计算拿到启动阶段，避免在运行中间件中进行计算")])],1)])],1)]),t._v(" "),a("p",[a("font",{attrs:{color:"#1E90FF"}},[a("strong",[t._v("② 内存")])])],1),t._v(" "),a("ul",[a("li",[a("font",{attrs:{color:"#DD1144"}},[t._v("减少内存的使用")]),t._v("\n+"),a("font",{attrs:{color:"#1E90FF"}})],1),t._v(" "),a("li",[a("font",{attrs:{color:"#DD1144"}},[t._v("必须要检查内存是否存在泄露")])],1)]),t._v(" "),a("p",[a("font",{attrs:{color:"#1E90FF"}},[a("strong",[t._v("③ 进程")])])],1),t._v(" "),a("ul",[a("li",[a("font",{attrs:{color:"#DD1144"}},[t._v("使用cluster模块进行进程优化")])],1)]),t._v(" "),a("p",[a("strong",[t._v("参考资料")])]),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://blog.csdn.net/weixin_34417635/article/details/89121296",target:"_blank",rel:"noopener noreferrer"}},[t._v("苏宁Nodejs性能优化实战"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"http://www.imooc.com/article/292954",target:"_blank",rel:"noopener noreferrer"}},[t._v("打造高性能Node服务器"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.imooc.com/article/34378",target:"_blank",rel:"noopener noreferrer"}},[t._v("记一次Node项目的优化"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://juejin.im/entry/5a56d1db6fb9a01cc1223c6d",target:"_blank",rel:"noopener noreferrer"}},[t._v("(阿里国际UED)唯快不破，让nodejs再快一点"),a("OutboundLink")],1)])])])},[],!1,null,null,null);s.default=r.exports}}]);