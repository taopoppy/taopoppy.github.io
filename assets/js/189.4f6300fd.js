(window.webpackJsonp=window.webpackJsonp||[]).push([[189],{372:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"错误处理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#错误处理","aria-hidden":"true"}},[t._v("#")]),t._v(" 错误处理")]),t._v(" "),a("h2",{attrs:{id:"错误处理简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#错误处理简介","aria-hidden":"true"}},[t._v("#")]),t._v(" 错误处理简介")]),t._v(" "),a("p",[t._v("什么是"),a("font",{attrs:{color:"#3eaf7c"}},[t._v("错误处理")]),t._v("：")],1),t._v(" "),a("ul",[a("li",[t._v("编程语言或者计算机硬件里的一种机制")]),t._v(" "),a("li",[t._v("处理软件或者信息系统中出现的异常状态")])]),t._v(" "),a("p",[a("font",{attrs:{color:"#3eaf7c"}},[t._v("异常状况")]),t._v("有哪些？")],1),t._v(" "),a("ul",[a("li",[t._v("运行时错误，返回"),a("font",{attrs:{color:"#CC99CD"}},[t._v("500")]),t._v(": "),a("code",[t._v("javascript")]),t._v("语法没有错误，但是在运行的时候出了错，比如说求某个变量的属性，结果在运行的时候这个变量为"),a("code",[t._v("undefined")])],1),t._v(" "),a("li",[t._v("逻辑错误，返回"),a("font",{attrs:{color:"#CC99CD"}},[t._v("404")]),t._v(": 比如你请求的网页不存在")],1),t._v(" "),a("li",[t._v("先决条件错误，返回"),a("font",{attrs:{color:"#CC99CD"}},[t._v("412")]),t._v(": 比如你请求特定用户，而你写的用户id不存在或者就是瞎胡写的")],1),t._v(" "),a("li",[t._v("无法处理的实体，返回"),a("font",{attrs:{color:"#CC99CD"}},[t._v("422")]),t._v(": 比如参数格式不对")],1)]),t._v(" "),a("p",[t._v("为什么要用错误处理？")]),t._v(" "),a("ul",[a("li",[t._v("防止程序挂掉: "),a("code",[t._v("javascript")]),t._v("中防止程序挂掉的语法就是"),a("code",[t._v("try...catch...")]),t._v(",包括"),a("code",[t._v("koa")]),t._v("的源码也是用"),a("code",[t._v("catch")]),t._v("的一个"),a("code",[t._v("promise")])]),t._v(" "),a("li",[t._v("告诉用户错误信息")]),t._v(" "),a("li",[t._v("便于开发者调试")])]),t._v(" "),a("h2",{attrs:{id:"koa自带错误处理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#koa自带错误处理","aria-hidden":"true"}},[t._v("#")]),t._v(" koa自带错误处理")]),t._v(" "),a("p",[t._v("制造"),a("code",[t._v("404")]),t._v(","),a("code",[t._v("412")]),t._v(","),a("code",[t._v("500")]),t._v("三种错误，然后看看"),a("code",[t._v("koa")]),t._v("自带的错误处理做了什么")]),t._v(" "),a("h3",{attrs:{id:"_1-404错误"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-404错误","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 404错误")]),t._v(" "),a("p",[t._v("模拟"),a("code",[t._v("404")]),t._v("错误非常简单，因为"),a("code",[t._v("404")]),t._v("错误是客户端的问题，比如我们请求了一个不存的"),a("code",[t._v("url")]),t._v(",或者我们对存在的"),a("code",[t._v("url")]),t._v("使用了不存在请求方法，都会返回"),a("code",[t._v("404")]),t._v("状态码，而且返回体是个"),a("code",[t._v("Not Found")]),t._v("的文本。")]),t._v(" "),a("h3",{attrs:{id:"_2-412错误"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-412错误","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. 412错误")]),t._v(" "),a("p",[a("code",[t._v("412")]),t._v("错误表示的先决条件失败，我们在"),a("code",[t._v("controllers/users.js")]),t._v("中添加一些代码:")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" db "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"李雷"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UsersCtl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("findById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("412")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'先决条件失败，用户id不存在，因为id大于等于数组长度'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 手动抛错")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UsersCtl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("当先决条件不符合的时候我们就要手动去抛出错误"),a("code",[t._v("ctx.throw(412)")]),t._v(",然后返回结果是"),a("code",[t._v("412")]),t._v("的状态码和"),a("code",[t._v("先决条件失败，用户id不存在，因为id大于等于数组长度")]),t._v("的文本。当然第二个参数不填的话就返回"),a("code",[t._v("Precondition Failed")]),t._v("的文本，意思也是先决条件失败。")]),t._v(" "),a("h3",{attrs:{id:"_3-500错误"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-500错误","aria-hidden":"true"}},[t._v("#")]),t._v(" 3. 500错误")]),t._v(" "),a("p",[t._v("一般都是运行时错误，我们依然在"),a("code",[t._v("controllers/users.js")]),t._v("中添加一些代码:")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" db "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"李雷"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UsersCtl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("find")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("b                       "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发生运行时错误")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" db\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UsersCtl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("上述代码语法没有问题，运行的时候就有问题，在"),a("code",[t._v("postman")]),t._v("会报状态码为"),a("code",[t._v("500")]),t._v("的错误，返回文本为"),a("code",[t._v("Internal Server Error")]),t._v("，然年在程序的命令行我们会发现"),a("code",[t._v("ReferenceError: a is not defined")]),t._v("的错误提示，下面会有错误堆栈的提示，我们只要按住"),a("code",[t._v("ctrl")]),t._v("点击错误提示路径，就能直接跳转到错误代码的地方。")]),t._v(" "),a("p",[t._v("这个就是"),a("code",[t._v("koa")]),t._v("自带的错误处理，但是虽然"),a("code",[t._v("koa")]),t._v("自带的错误处理在很多时候够用了，但是对于"),a("code",[t._v("RESTful")]),t._v("最佳实践我们希望返回的是"),a("code",[t._v("json")]),t._v(",而上述都是文本，下面我们还会去自己写中间件和使用社区优秀的第三方插件。")]),t._v(" "),a("h2",{attrs:{id:"自己编写中间件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自己编写中间件","aria-hidden":"true"}},[t._v("#")]),t._v(" 自己编写中间件")]),t._v(" "),a("p",[t._v("错误处理和中间件有什么关系？")]),t._v(" "),a("p",[t._v("如果"),a("font",{attrs:{color:"#3eaf7c"}},[t._v("你想自定义错误逻辑处理，那就要写一个中间件，并将中间件放再中间件链条的最前面，然后使用一个try catch语法，将next函数放在try语法当中，这样所有中间件的错误都能在try中捕获到")])],1),t._v(" "),a("p",[t._v("开始编写中间件，我们在``index.js`启动文件中写下面的这样一段代码：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// index.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 错误处理中间件")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("statusCode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3001")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'启动到了3001端口'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("img",{attrs:{src:t.$withBase("/errorhand1.png"),alt:"错误处理"}}),t._v(" "),a("p",[t._v("我们访问"),a("code",[t._v("http://localhost:3001/users/2")]),t._v("，然后在"),a("code",[t._v("controllers/users.js")]),t._v("中通过"),a("code",[t._v("ctx.thorw(412)")]),t._v("抛出了错误，在这里通过错误处理中间件捕获到错误，并以json形式返回。通过上图你可以看到"),a("code",[t._v("error")]),t._v("本身有"),a("code",[t._v("massage")]),t._v(","),a("code",[t._v("name")]),t._v(","),a("code",[t._v("stack")]),t._v("三个属性，然后继承自"),a("code",[t._v("HttpError")]),t._v("的三个属性"),a("code",[t._v("expose")]),t._v("，"),a("code",[t._v("status")]),t._v("，"),a("code",[t._v("statusCode")]),t._v("，所以我们返回"),a("code",[t._v("json")]),t._v("形式中"),a("code",[t._v("message")]),t._v("和"),a("code",[t._v("status")]),t._v("都是从"),a("code",[t._v("error")]),t._v("这个错误对象上拿到的，不是瞎编的。")]),t._v(" "),a("p",[t._v("所以我们手动写的这个错误处理实际已经能捕获到"),a("font",{attrs:{color:"#3eaf7c"}},[t._v(" 手动抛出的错误")]),t._v(" 和 "),a("font",{attrs:{color:"#3eaf7c"}},[t._v("运行时错误 ")]),t._v("了，十分强大。但是值得注意的是：404错误是不走我们自己写的这个错误处理的中间件的")],1),t._v(" "),a("h2",{attrs:{id:"koa-json-error"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#koa-json-error","aria-hidden":"true"}},[t._v("#")]),t._v(" koa-json-error")]),t._v(" "),a("p",[t._v("真实开发中，重复造轮子是不可取的，在众多错误处理的轮子中，"),a("code",[t._v("koa-json-error")]),t._v("是比较优秀的一款插件，因为这个插件专门针对"),a("code",[t._v("json")]),t._v("的，很符合"),a("code",[t._v("RESTful")]),t._v("的最佳实践的要求，另外还有很多丰富的功能，比如返回错误的堆栈信息到客户端，方便调试、还可以配置返回信息、还能在"),a("code",[t._v("400")]),t._v(","),a("code",[t._v("404")]),t._v("的时候也返回json。")]),t._v(" "),a("h3",{attrs:{id:"_1-安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 安装")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" i koa-json-error --save\n")])])]),a("h3",{attrs:{id:"_2-使用默认配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-使用默认配置","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. 使用默认配置")]),t._v(" "),a("p",[t._v("接着我们将使用"),a("code",[t._v("koa-json-error")]),t._v("的默认配置处理错误,在"),a("code",[t._v("index.js")]),t._v("文件中引入中间件并注册")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" error "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa-json-error'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 引用")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注册")]),t._v("\n")])])]),a("p",[t._v("使用默认配置就是这么简单，下面我们将看看使用中间件后的错误返回都返回什么：")]),t._v(" "),a("ul",[a("li",[a("font",{attrs:{color:"#3eaf7c"}},[t._v("status")]),t._v("：状态码")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#3eaf7c"}},[t._v("name")]),t._v("：错误类型的名称")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#3eaf7c"}},[t._v("message")]),t._v("：错误信息")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#3eaf7c"}},[t._v("stack")]),t._v("：错误的堆栈信息")],1)]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 测试404的返回结果")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"message"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Not Found"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"NotFoundError"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stack"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"NotFoundError: Not Found\\n    at Object.throw (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa\\\\lib\\\\context.js:97:11)\\n    at next.then (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\_koa-json-error@3.1.2@koa-json-error\\\\lib\\\\middleware.js:52:58)\\n    at process._tickCallback (internal/process/next_tick.js:68:7)"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"status"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("404")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 测试412的返回结果")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"message"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"先决条件失败，用户id不存在，因为id大于等于数组长度"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PreconditionFailedError"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stack"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PreconditionFailedError: 先决条件失败，用户id不存在，因为id大于等于数组长度\\n    at Object.throw (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa\\\\lib\\\\context.js:97:11)\\n    at findById (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\app\\\\controllers\\\\users.js:16:16)\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\node_modules\\\\koa-compose\\\\index.js:44:32)\\n    at next (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\node_modules\\\\koa-compose\\\\index.js:45:18)\\n    at C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\lib\\\\router.js:346:16\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\node_modules\\\\koa-compose\\\\index.js:44:32)\\n    at C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\node_modules\\\\koa-compose\\\\index.js:36:12\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\lib\\\\router.js:351:31)\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-compose\\\\index.js:42:32)\\n    at allowedMethods (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\lib\\\\router.js:407:12)"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"status"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("412")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 测试500的返回结果")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ReferenceError"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"message"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"a is not defined"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stack"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ReferenceError: a is not defined\\n    at find (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\app\\\\controllers\\\\users.js:4:5)\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\node_modules\\\\koa-compose\\\\index.js:44:32)\\n    at next (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\node_modules\\\\koa-compose\\\\index.js:45:18)\\n    at C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\lib\\\\router.js:346:16\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\node_modules\\\\koa-compose\\\\index.js:44:32)\\n    at C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\node_modules\\\\koa-compose\\\\index.js:36:12\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\lib\\\\router.js:351:31)\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-compose\\\\index.js:42:32)\\n    at allowedMethods (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\lib\\\\router.js:407:12)\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-compose\\\\index.js:42:32)"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"status"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 测试422的返回结果")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"message"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Unprocessable Entity"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"UnprocessableEntityError"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stack"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"UnprocessableEntityError: Unprocessable Entity\\n    at Object.throw (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa\\\\lib\\\\context.js:97:11)\\n    at create (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\app\\\\controllers\\\\users.js:15:16)\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\node_modules\\\\koa-compose\\\\index.js:44:32)\\n    at next (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\node_modules\\\\koa-compose\\\\index.js:45:18)\\n    at C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\lib\\\\router.js:346:16\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\node_modules\\\\koa-compose\\\\index.js:44:32)\\n    at C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\node_modules\\\\koa-compose\\\\index.js:36:12\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\lib\\\\router.js:351:31)\\n    at dispatch (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-compose\\\\index.js:42:32)\\n    at allowedMethods (C:\\\\Users\\\\Administrator\\\\Desktop\\\\REST-API\\\\node_modules\\\\koa-router\\\\lib\\\\router.js:407:12)"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"status"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("422")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_3-修改配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-修改配置","aria-hidden":"true"}},[t._v("#")]),t._v(" 3. 修改配置")]),t._v(" "),a("p",[t._v("关于"),a("code",[t._v("koa-json-error")]),t._v("中间件的更多配置和学习参考"),a("a",{attrs:{href:"https://www.npmjs.com/package/koa-json-error",target:"_blank",rel:"noopener noreferrer"}},[t._v("官网"),a("OutboundLink")],1),t._v("或者"),a("a",{attrs:{href:"https://github.com/koajs/json-error",target:"_blank",rel:"noopener noreferrer"}},[t._v("github"),a("OutboundLink")],1),t._v("\n最后我们来修改配置使其在生产环境下禁用错误堆栈的返回，因为可以从上述的返回结果中看见错误堆栈信息字段"),a("code",[t._v("stack")]),t._v("实际上有好多，我们在生产环境中不需要这个字段，所以我们想让其在生产环境中启动的时候去掉该字段,所以我们修改"),a("code",[t._v("index.js")]),t._v("中的代码如下：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" error "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa-json-error'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("postFormat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("rest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'production'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" rest "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("rest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n")])])]),a("p",[t._v("上面这段代码啥意思，就是说我们是通过"),a("code",[t._v("postFormat")]),t._v("这个参数去配置返回信息的格式，返回信息是个对象，有四个参数，就是我们上面说的"),a("code",[t._v("message")]),t._v(","),a("code",[t._v("name")]),t._v(","),a("code",[t._v("stack")]),t._v(","),a("code",[t._v("status")]),t._v(",只是我们把除了"),a("code",[t._v("stack")]),t._v("其他三个参数解构到一起。我们在生产环境的时候不需要"),a("code",[t._v("stack")]),t._v("，所以我们判断为生产环境的时候就只返回其他三个参数，开发环境就都返回，便于调试。")]),t._v(" "),a("p",[t._v("当然由于"),a("code",[t._v("windows")]),t._v("平台不能直接在"),a("code",[t._v("package.json")]),t._v("文件中的"),a("code",[t._v("scripts")]),t._v("中写"),a("code",[t._v("NODE_DEV=production")]),t._v(",所以我们又需要一个新的插件"),a("font",{attrs:{color:"#3eaf7c"}},[t._v("cross-env来帮助我们跨平台设置环境变量")]),t._v(",下载和使用如下：")],1),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 下载")]),t._v("\nnpm install cross"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("env "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("save"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("dev\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用在package.json")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"scripts"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"start"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cross-env NODE_ENV=production pm2 app/index.js"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dev"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cross-env NODE_ENV=dev nodemon app/index.js"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),a("h2",{attrs:{id:"koa-parameter参数校验"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#koa-parameter参数校验","aria-hidden":"true"}},[t._v("#")]),t._v(" koa-parameter参数校验")]),t._v(" "),a("p",[t._v("前面我们讲到"),a("code",[t._v("422")]),t._v("这个无法处理实体的错误，一般都是请求体的格式或者参数格式不对导致的，那么我们怎么判断参数格式正确的呢？")]),t._v(" "),a("p",[t._v("我们首先想到的就是"),a("code",[t._v("if-else")]),t._v("来对"),a("code",[t._v("ctx.request.body")]),t._v("中的参数的类型和是否必选都写一遍，但是很累赘，比如这样：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("422")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'姓名必须为string类型'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("age "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'number'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("422")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'年龄必须为number类型'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("所以我们选择更加优雅的"),a("code",[t._v("koa-parameter")])]),t._v(" "),a("h3",{attrs:{id:"_1-安装koa-parameter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装koa-parameter","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 安装koa-parameter")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" koa-parameter --save\n")])])]),a("p",[t._v("然后引入和注册")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" parameter "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa-parameter'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("postFormat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("rest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'production'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" rest "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("rest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bodyparser")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注册body解析器")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("parameter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注册参数校验中间件")]),t._v("\n")])])]),a("ul",[a("li",[t._v("特别注意我们这个参数校验注册的顺序，"),a("font",{attrs:{color:"#3eaf7c"}},[t._v("错误处理中间件一定在最前面，参数校验一点在body解析器的后面")]),t._v("，因为对于请求体一定要先解析拿到手，再去校验其中参数的正确与否")],1),t._v(" "),a("li",[t._v("另外要注意，参数"),a("code",[t._v("app")]),t._v("不能忘记写，因为这个中间件是往"),a("code",[t._v("ctx")]),t._v("上面添加了一些方法来帮助校验的，后面你就能看到了")])]),t._v(" "),a("h3",{attrs:{id:"_2-检验测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-检验测试","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. 检验测试")]),t._v(" "),a("p",[t._v("现在我们使用"),a("code",[t._v("post")]),t._v("请求"),a("code",[t._v("http://localhost:3001/users")]),t._v("，也就是新建用户，然后我们校验的代码是下面这样：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//controllers/users.js")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("verifyParams")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" required"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      age"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'number'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" required"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("我们校验了"),a("code",[t._v("name")]),t._v("和"),a("code",[t._v("age")]),t._v('字段，然后我们提交{ "name": 123}这样的错误格式来看看返回结果：')]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"message"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Validation Failed"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"errors"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"message"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"should be a string"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"code"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"invalid"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"field"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"params"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("123")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("ul",[a("li",[a("font",{attrs:{color:"#3eaf7c"}},[t._v("message")]),t._v("：错误信息类型名称")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#3eaf7c"}},[t._v("errors")]),t._v("：错误的具体信息")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#3eaf7c"}},[t._v("params")]),t._v("：错误的具体字段")],1)]),t._v(" "),a("p",[t._v("上述错误我们就很能清楚的看到是"),a("code",[t._v("name")]),t._v("这个字段应该是"),a("code",[t._v("string")]),t._v("类型，但是你提交的是数字类型的")]),t._v(" "),a("p",[t._v('我们再提交{"age": 123}这样的缺失必要数据来看看返回结果：')]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"message"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Validation Failed"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"errors"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"message"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"required"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"field"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"code"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"missing_field"')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"params"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"age"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("123")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("上述错误就很清晰的看出"),a("code",[t._v("name")]),t._v("这个字段是必须要的，但是你没有传，关于"),a("code",[t._v("koa-parameter")]),t._v("中间件更多的配置和学习请参照"),a("a",{attrs:{href:"https://www.npmjs.com/package/koa-parameter",target:"_blank",rel:"noopener noreferrer"}},[t._v("官网"),a("OutboundLink")],1),t._v("或者"),a("a",{attrs:{href:"https://github.com/koajs/parameter",target:"_blank",rel:"noopener noreferrer"}},[t._v("github"),a("OutboundLink")],1)])])},[],!1,null,null,null);s.default=e.exports}}]);