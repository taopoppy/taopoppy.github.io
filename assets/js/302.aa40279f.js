(window.webpackJsonp=window.webpackJsonp||[]).push([[302],{490:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"oauth接入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#oauth接入","aria-hidden":"true"}},[t._v("#")]),t._v(" OAuth接入")]),t._v(" "),a("h2",{attrs:{id:"认证和授权"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#认证和授权","aria-hidden":"true"}},[t._v("#")]),t._v(" 认证和授权")]),t._v(" "),a("p",[t._v("认证（"),a("code",[t._v("Authentication")]),t._v("）是什么？"),a("font",{attrs:{color:"#DD1144"}},[t._v("通俗的来说就是：你怎么证明你是你自己，证明自己是某种身份")]),t._v("，比如身份证是用来帮助你证明你是中华人民共和国公民，学生证证明你是某个大学的学生，在互联网当中，用户名和密码可以代表你是网站中的已注册过的用户。")],1),t._v(" "),a("p",[t._v("当然互联网中的认证有"),a("font",{attrs:{color:"#1E90FF"}},[t._v("用户名和密码")]),t._v("、"),a("font",{attrs:{color:"#1E90FF"}},[t._v("邮箱发送登录连接")]),t._v("、"),a("font",{attrs:{color:"#1E90FF"}},[t._v("手机号接收验证码")]),t._v("，完成一个高可用的认证系统是很难的，考虑的问题很多，比如让用户设置高强度的密码、密码存储进行加密、使用"),a("code",[t._v("https")]),t._v("保证客户端和服务端进行安全通行，防止密码被中间人获取等等，所以这都是很复杂的东西")],1),t._v(" "),a("p",[t._v("但是使用"),a("code",[t._v("OAuth")]),t._v("就可以很方便的避免考虑这些问题，"),a("font",{attrs:{color:"#DD1144"}},[t._v("OAuth帮助我们实现了认证，我们只需要等待授权")])],1),t._v(" "),a("p",[t._v("授权（"),a("code",[t._v("Authorization")]),t._v("）,"),a("font",{attrs:{color:"#1E90FF"}},[t._v("通俗的来说就是你有做哪些事情的权利")]),t._v("，比如在安装手机应用的时候会询问你应用是否可以访问手机的某些功能，还比如操作系统有很多用户，除了root用户有所有的操作的权利，其他用户只有部分权利。同理在"),a("code",[t._v("OAuth")]),t._v("后，被授权方会收获一定的权限。")],1),t._v(" "),a("p",[t._v("在网页当中，最直观的授权就是"),a("code",[t._v("cookie")]),t._v("，比如我们登陆"),a("code",[t._v("github")]),t._v("的时候，使用密码登录到"),a("code",[t._v("github")]),t._v("服务器实现了对用户的认证，然后"),a("code",[t._v("github")]),t._v("服务器会给你所使用的当前的浏览器一些权利，权利的容器实际上就是"),a("code",[t._v("cookie")]),t._v("，所以你在后面去做其他事情的时候浏览器向"),a("code",[t._v("github")]),t._v("服务器发送请求的时候会携带这个"),a("code",[t._v("cookie")]),t._v("，表示我有你给我权利去做这个事情。")]),t._v(" "),a("p",[a("font",{attrs:{color:"#DD1144"}},[t._v("但是授权并不一定要先认证")]),t._v("、比如发放优惠券，商家是不知道这些优惠券最终会在谁的手上，但是只要你持有优惠券就可以享受优惠，"),a("font",{attrs:{color:"#9400D3"}},[t._v("OAuth就是授权的一种方式，通过token的方式进行权限的授予的")])],1),t._v(" "),a("h2",{attrs:{id:"什么是oauth"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是oauth","aria-hidden":"true"}},[t._v("#")]),t._v(" 什么是OAuth")]),t._v(" "),a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("OAuth是一种行业标准的授权方式")]),t._v("，在这种方式当中存在了三个角色，分别是"),a("font",{attrs:{color:"#1E90FF"}},[t._v("客户端")]),t._v("、"),a("font",{attrs:{color:"#1E90FF"}},[t._v("服务端")]),t._v("、"),a("font",{attrs:{color:"#1E90FF"}},[t._v("授权服务器")]),t._v("，基本就是围绕在这三个角色中进行的。")],1),t._v(" "),a("p",[a("font",{attrs:{color:"#DD1144"}},[t._v("OAuth有多种授权方式")]),t._v("，比如")],1),t._v(" "),a("ul",[a("li",[a("code",[t._v("Authorization Code")]),t._v("（最好用，学习重点）")]),t._v(" "),a("li",[a("code",[t._v("Refresh Token")]),t._v("（不常用的协议）")]),t._v(" "),a("li",[a("code",[t._v("Device Code")]),t._v("（不常用）")]),t._v(" "),a("li",[a("code",[t._v("Password")]),t._v("（不太安全）")]),t._v(" "),a("li",[a("code",[t._v("Implicit")]),t._v("（不安全）")]),t._v(" "),a("li",[a("code",[t._v("Client Credentials")]),t._v("（客户端的相关权限，和用户无关）")])]),t._v(" "),a("p",[t._v("要注意的时候，虽然"),a("code",[t._v("OAuth")]),t._v("有这么多的授权方式，但是每个"),a("code",[t._v("OAuth")]),t._v("提供商并不一定提供这么多的方式，有的可能只支持其中的一种授权方式，具体的要看提供商怎么提供的")]),t._v(" "),a("img",{attrs:{src:t.$withBase("/react_ssr_oauth_one.png"),alt:"Authorization Code"}}),t._v(" "),a("ul",[a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("网站使用OAuth需要到github上去申请，申请之后会获得client_id和client_secret")])],1)]),t._v(" "),a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("首先要在我们的网页上发起一个redirect，并携带上client_id，让github知道用户现在要给哪个客户端授权")])],1)]),t._v(" "),a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("github跳出认证，就是用户名和密码的输入框。")])],1)]),t._v(" "),a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("认证完毕后会redirect一个url，并携带上code参数，虽然重定向是在客户端的，但是客户端要请求到服务器，所以code主要是在服务端用的")])],1)]),t._v(" "),a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("服务端拿到code会结合client_secret请求github的某个api来获取token")])],1)]),t._v(" "),a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("拿到这个token就可以通过tokne和github的api进行交互，因为github会询问用户是否要开放一些权限给token，所以这个token会携带一些权限信息")])],1)])]),t._v(" "),a("h2",{attrs:{id:"oauth的认证流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#oauth的认证流程","aria-hidden":"true"}},[t._v("#")]),t._v(" OAuth的认证流程")]),t._v(" "),a("img",{attrs:{src:t.$withBase("/react_ssr_oauth_two.png"),alt:"oauth认证流程"}}),t._v(" "),a("ul",[a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("跳转认证(1)")]),t._v("：在网页上点击某个按钮，比如常常出现在登录界面下方的第三方登录的微信图标、qq图标，依旧"),a("code",[t._v("github")]),t._v("的图标，然后会跳转到"),a("code",[t._v("Github OAuth")]),t._v("的认证界面（比如从我们自己的网站"),a("code",[t._v("http://nextjs.w2deep.com")]),t._v("跳转到"),a("code",[t._v("github")]),t._v("的"),a("code",[t._v("OAuth")]),t._v("的地址："),a("code",[t._v("https://github.com/login/oauth/authorize?client_id=b197d1e973afb0bc9a00&redirect_url=http://nextjs.w2deep.com/auth&scope=user")]),t._v(",后者地址中的client_id就携带在其中，还有scope=user就表示我们想获取用户的信息权限）")],1)]),t._v(" "),a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("完成认证(2)")]),t._v("：在"),a("code",[t._v("Github OAuth")]),t._v("的认证界面输入用户名和密码完成登录，并且用户要在授权窗口中点击确认后进行跳转")],1)]),t._v(" "),a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("跳转连接(3)")]),t._v("：跳转到浏览器中的某个链接，并携带"),a("code",[t._v("code")]),t._v("（比如"),a("code",[t._v("github")]),t._v("服务器跳回到我们自己的网站，并携带"),a("code",[t._v("code")]),t._v("，如"),a("code",[t._v("http://nextjs.w2deep.com/auth?code=a4e2898b223e6a144f")]),t._v("，这个"),a("code",[t._v("code")]),t._v("是一次性的，不能通过这个"),a("code",[t._v("code")]),t._v("去第二次获取"),a("code",[t._v("token")]),t._v("）")],1)]),t._v(" "),a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("服务器拿到code(4)")]),t._v("：浏览器向服务端发送请求，服务端拿到跳转中携带的"),a("code",[t._v("code")])],1)]),t._v(" "),a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("服务器请求access_token(5)")]),t._v("：拿到"),a("code",[t._v("code")]),t._v("会结合"),a("code",[t._v("clien_secret")]),t._v("去向"),a("code",[t._v("github")]),t._v("的服务器请求"),a("code",[t._v("access_token")])],1)]),t._v(" "),a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("github返回token(6)")]),t._v("："),a("code",[t._v("github")]),t._v("服务器根据服务器发来的"),a("code",[t._v("code")]),t._v("和"),a("code",[t._v("clien_secret")]),t._v("生成"),a("code",[t._v("access_token")]),t._v("返回给服务器")],1)]),t._v(" "),a("li",[a("p",[a("font",{attrs:{color:"#9400D3"}},[t._v("服务器返回响应(7.8)")]),t._v("：服务器拿到"),a("code",[t._v("access_token")]),t._v("存储到"),a("code",[t._v("session")]),t._v("当中，然后返回请求，写入浏览器的"),a("code",[t._v("cookie")]),t._v("当中。")],1)])]),t._v(" "),a("h2",{attrs:{id:"注册github-oauth-app"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注册github-oauth-app","aria-hidden":"true"}},[t._v("#")]),t._v(" 注册github-OAuth-App")]),t._v(" "),a("p",[t._v("进入你自己的"),a("code",[t._v("github")]),t._v("，选择你右上角的头像，选择"),a("code",[t._v("setting")]),t._v(",在左边的导航列表当中选择"),a("code",[t._v("Developer settings")]),t._v("，然后再在左边的导航列表中选择"),a("code",[t._v("OAuth Apps")]),t._v(",选择"),a("code",[t._v("New OAuth App")]),t._v("进入创建页面，在创建页面中有很多选项")]),t._v(" "),a("img",{attrs:{src:t.$withBase("/react_ssr_oauth_three.png"),alt:"注册oauth apps"}}),t._v(" "),a("ul",[a("li",[a("font",{attrs:{color:"#9400D3"}},[t._v("Application name")]),t._v("：名称，可以随便填，我填的是"),a("code",[t._v("imooc-taopoppy")])],1),t._v(" "),a("li",[a("font",{attrs:{color:"#9400D3"}},[t._v("Homepage URL")]),t._v("：这个虽然是必填，但是在整个流程中不重要，我们在开发阶段写成"),a("code",[t._v("http://localhost:3001")]),t._v("即可，一般来说后面都会改成项目上线的地址")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#9400D3"}},[t._v("Authorization callback URL")]),t._v("：这个地址就是"),a("code",[t._v("github")]),t._v("在用户认证和授权完后跳转的地址，会携带"),a("code",[t._v("code")]),t._v("的地址，我们填"),a("code",[t._v("http://localhost:3000/auth")]),t._v(",项目上线的时候是要填对应的域名和对应的路由地址的。")],1)]),t._v(" "),a("p",[t._v("然后点击最下面的"),a("code",[t._v("Register application")]),t._v("之后，就会显示出"),a("code",[t._v("Client_id")]),t._v("和"),a("code",[t._v("Clien_secret")]),t._v("，如下图：")]),t._v(" "),a("img",{attrs:{src:t.$withBase("/react_ssr_oauth_four.png"),alt:"id和密码"}}),t._v(" "),a("p",[t._v("注意的是"),a("code",[t._v("clien_secret")]),t._v("可以通过点击"),a("code",[t._v("Reset client secret")]),t._v("这个按钮去重置，"),a("code",[t._v("Client ID")]),t._v("是没有必要去重置的，因为本身就是要暴露给外部的。然后"),a("code",[t._v("Revoke all user tokens")]),t._v("是清除所有这个"),a("code",[t._v("app")]),t._v("上的授权成功的用户的"),a("code",[t._v("token")]),t._v("的按钮。在这个网页的下面还可以手动修改"),a("code",[t._v("Application name")]),t._v("、"),a("code",[t._v("Homepage URL")]),t._v("、"),a("code",[t._v("Authorization callback URL")]),t._v("。")]),t._v(" "),a("p",[t._v("那这两个东西当然非常重要了，所以我们需要在项目当中去创建"),a("code",[t._v("config.js")]),t._v("去保存它们：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// nextjs-project/config.js")]),t._v("\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tgithub"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tclient_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'bc3225e59db1965fbeb4'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tclient_secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'a2e086590fc4233f71bcf069d6d89818bc23185a'")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"oauth字段讲解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#oauth字段讲解","aria-hidden":"true"}},[t._v("#")]),t._v(" OAuth字段讲解")]),t._v(" "),a("h3",{attrs:{id:"_1-跳转字段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-跳转字段","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 跳转字段")]),t._v(" "),a("p",[t._v("当我们要从自己的网站上跳转到"),a("code",[t._v("github")]),t._v("的授权网站时，可以带很多的参数，具体有哪些参数，以及这些参数的作用，我们可以到"),a("a",{attrs:{href:"https://developer.github.com/apps/building-oauth-apps/authorizing-oauth-apps/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官网"),a("OutboundLink")],1),t._v("参考.")]),t._v(" "),a("p",[t._v("下面这个字段为例："),a("code",[t._v("https://github.com/login/oauth/authorize?client_id=b197d1e973afb0bc9a00&redirect_url=http://nextjs.w2deep.com/auth&scope=user")]),t._v("我们来简单介绍一下：")]),t._v(" "),a("ul",[a("li",[a("font",{attrs:{color:"#9400D3"}},[t._v("client_id")]),t._v("：（必带）在注册"),a("code",[t._v("OAuth Apps")]),t._v("时候的那个"),a("code",[t._v("client_id")]),t._v("。")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#9400D3"}},[t._v("scope")]),t._v("：（选带）代表我们希望获得的授权有哪些，比如"),a("code",[t._v("user")]),t._v("、"),a("code",[t._v("repo")]),t._v("等，这些可以使用逗号分开写在"),a("code",[t._v("scope=")]),t._v("后面，具体参考"),a("a",{attrs:{href:"https://developer.github.com/apps/building-oauth-apps/understanding-scopes-for-oauth-apps/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官网"),a("OutboundLink")],1)],1),t._v(" "),a("li",[a("font",{attrs:{color:"#9400D3"}},[t._v("redirect_uri")]),t._v("：（选带）就是认证授权成功后要返回能携带"),a("code",[t._v("code")]),t._v("的网址")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#9400D3"}},[t._v("login")]),t._v("：（选带）是否允许用户登录，默认为"),a("code",[t._v("true")]),t._v("，如果用户没有在浏览器中登录"),a("code",[t._v("github")]),t._v("，可以允许先通过用户名和密码进行登录。")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#9400D3"}},[t._v("state")]),t._v("：（选带）我们自己要用到的字段，我们在跳转和"),a("code",[t._v("github")]),t._v("返回的"),a("code",[t._v("code")]),t._v("的时候都带上"),a("code",[t._v("state")]),t._v("，确保两次是相同的，来保证安全性")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#9400D3"}},[t._v("allow_signup")]),t._v("：（选带）代表是否允许用户在没有"),a("code",[t._v("github")]),t._v("账号的时候先走注册，再登录授权")],1)]),t._v(" "),a("p",[t._v("所以实际上现在我们知道只要带上"),a("code",[t._v("client_id")]),t._v("，就已经能跳转到"),a("code",[t._v("github")]),t._v("认证的页面了，我们来访问"),a("code",[t._v("https://github.com/login/oauth/authorize?client_id=bc3225e59db1965fbeb4")]),t._v("就能看到浏览器显示的界面：")]),t._v(" "),a("img",{attrs:{src:t.$withBase("/react_ssr_oauth_five.png"),alt:"授权"}}),t._v(" "),a("p",[t._v("当然上面是没有带"),a("code",[t._v("scope")]),t._v("参数的，所以它只会显示"),a("code",[t._v("Public data only")]),t._v("，代表只给你最简单的权限。我们要带点参数，比如访问下面这个地址："),a("code",[t._v("https://github.com/login/oauth/authorize?client_id=bc3225e59db1965fbeb4&scope=user,repo,gist")]),t._v("，它就会授权用户，仓库以及"),a("code",[t._v("gist")]),t._v("的权限。")]),t._v(" "),a("img",{attrs:{src:t.$withBase("/react_ssr_oauth_six.png"),alt:"多种授权"}}),t._v(" "),a("p",[t._v("当然如果你仔细看"),a("a",{attrs:{href:"https://developer.github.com/apps/building-oauth-apps/understanding-scopes-for-oauth-apps/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官网"),a("OutboundLink")],1),t._v("，"),a("code",[t._v("user")]),t._v("、"),a("code",[t._v("repo")]),t._v("这些都是大的权限，里面包含好多小的权限，比如"),a("code",[t._v("user")]),t._v("包含"),a("code",[t._v("read:user")]),t._v("，"),a("code",[t._v("user:email")]),t._v("、"),a("code",[t._v("user:follow")]),t._v("这些，这些小权限也可以单独拿出来，直接写"),a("code",[t._v("user")]),t._v("就相当于包含了所有小的权限。")]),t._v(" "),a("p",[t._v("然后授权后"),a("code",[t._v("github")]),t._v("就会跳转到"),a("code",[t._v("redirect_url")]),t._v("指定的那个地址并带上"),a("code",[t._v("code")]),t._v("，我们在注册的时候"),a("code",[t._v("redirect_url")]),t._v("指定的是"),a("code",[t._v("http://localhost:3001/auth")]),t._v("，所以它最终跳转的地址就是"),a("code",[t._v("http://localhost:3001/auth?code=93d84b9041add8c47824")])]),t._v(" "),a("h3",{attrs:{id:"_2-请求token字段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-请求token字段","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. 请求token字段")]),t._v(" "),a("p",[t._v("服务器拿到了"),a("code",[t._v("code")]),t._v("之后，需要结合一些参数去"),a("code",[t._v("github")]),t._v("服务器上请求"),a("code",[t._v("access_token")]),t._v("，请求的相关参数包含下面几个：")]),t._v(" "),a("ul",[a("li",[a("font",{attrs:{color:"#9400D3"}},[t._v("client_id和client_secret")]),t._v("：这两个是必须的，表示我们拥有客户端权限")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#9400D3"}},[t._v("code")]),t._v("："),a("code",[t._v("code")]),t._v("本身也是必须的，表示用户给我们授权了")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#9400D3"}},[t._v("redirect_uri和state")]),t._v("：和上面的是一样的")],1)]),t._v(" "),a("p",[t._v("下面我们来使用"),a("font",{attrs:{color:"#DD1144"}},[t._v("restlet client")]),t._v("这个浏览器插件来发送一下"),a("code",[t._v("post")]),t._v("请求来获取一下"),a("code",[t._v("access_token")]),t._v("：\n"),a("img",{attrs:{src:t.$withBase("/react_ssr_oauth_seven.png"),alt:""}})],1),t._v(" "),a("p",[t._v("可以看到返回给我们的一串字符串"),a("code",[t._v("access_token=2429eeb510c604997db54f251c3f88152d81f4b0&scope=gist%2Crepo%2Cuser&token_type=bearer")]),t._v("，其中就包含了"),a("code",[t._v("access_token")]),t._v("还有授权的信息，和"),a("code",[t._v("token")]),t._v("的类型。"),a("font",{attrs:{color:"#1E90FF"}},[t._v("要注意的是，这个code是一次性的，之前就说过，不能用它来第二次请求access_token，当然它也是有过期时间的，如果已经使用不了就必须到github的授权页面重新授权，让github重新跳转并携带新的code")])],1),t._v(" "),a("p",[t._v("然后保存一下这个"),a("code",[t._v("access_token")]),t._v("，去请求一下"),a("code",[t._v("github")]),t._v("用户的信息")]),t._v(" "),a("ul",[a("li",[t._v("请求的地址："),a("code",[t._v("https://api.github.com/user")])]),t._v(" "),a("li",[t._v("请求的头部："),a("code",[t._v("Authorization： token 2429eeb510c604997db54f251c3f88152d81f4b0")])])]),t._v(" "),a("img",{attrs:{src:t.$withBase("/react_ssr_oauth_eight.png"),alt:""}}),t._v(" "),a("h2",{attrs:{id:"oauth-code认证和安全"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#oauth-code认证和安全","aria-hidden":"true"}},[t._v("#")]),t._v(" OAuth-code认证和安全")]),t._v(" "),a("p",[t._v("这种方式保证安全的策略有下面这几个：")]),t._v(" "),a("ul",[a("li",[a("font",{attrs:{color:"#DD1144"}},[t._v("一次性的code")]),t._v("，因为是一次性"),a("code",[t._v("code")]),t._v("，所以即便是泄露了也不会有影响，应该只能用一次")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#DD1144"}},[t._v("id+secret")]),t._v("：这种验证方式就保证了即使"),a("code",[t._v("code")]),t._v("被别人先拿到了，别人也不知道"),a("code",[t._v("clien_secret")]),t._v("，因为"),a("code",[t._v("clien_secret")]),t._v("是保存在我们自己的服务器上的，是不向外暴露的。")],1),t._v(" "),a("li",[a("font",{attrs:{color:"#DD1144"}},[t._v("redirect_uri")]),t._v("：如果参数中的"),a("code",[t._v("redirect_uri")]),t._v("和我们一开始注册"),a("code",[t._v("OAuth Apps")]),t._v("的时候在"),a("code",[t._v("Authorization callback URL")]),t._v("中填的不一样，那么直接就会报错，"),a("code",[t._v("code")]),t._v("都不会返回。")],1)]),t._v(" "),a("h2",{attrs:{id:"cookie和session"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cookie和session","aria-hidden":"true"}},[t._v("#")]),t._v(" cookie和session")]),t._v(" "),a("p",[t._v("首先我们创建"),a("code",[t._v("server/session-store.js")]),t._v(",书写"),a("code",[t._v("session")]),t._v("和"),a("code",[t._v("redis")]),t._v("之间相关的方法：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// server/session-store.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 统一在和session的redis中的数据前面添加一个前缀")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRedisSessionId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("sid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("`ssid:")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("sid"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("`")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RedisSessionStore")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 接收一个redis的client去操作redis")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("client")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("client "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" client\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取Redis中存储的session数据")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'get session'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRedisSessionId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 存储session数据到redis(ttl为过期时间)")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 外界使用应该使用毫秒，而redis中需要传入秒")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sess"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ttl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'set session'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRedisSessionId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" ttl "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'number'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      ttl "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Math"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ceil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ttl "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" sessStr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringify")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sess"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ttl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 有过期时间")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ttl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sessStr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 无过期时间")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sessStr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 从redis当中删除某个session")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("destroy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("sid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'destroy session'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRedisSessionId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("del")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" RedisSessionStore\n")])])]),a("p",[t._v("然后我们到服务端来书写代码：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// server.js")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" session "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa-session'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 引入session")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" RedisSessionStore "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./server/session-store.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 引入RedisSessionStore")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Redis "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ioredis'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 引入Redis")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 创建redis的client（全部使用默认配置）")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" redis "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Redis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("prepare")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\n\tserver"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("keys "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Taopoppy develop Github App'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 4. 设置一个给cookie加密的字符串")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 5. 配置session的配置")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SESSION_CONFIG")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'jid'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// cookie的key")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// maxAge: 60*1000, // 一分钟的过期时间（默认是86400000为一天）")]),t._v("\n\t\tstore"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RedisSessionStore")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 6. 中间件使用")]),t._v("\n\tserver"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("session")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SESSION_CONFIG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 7.1. 通过访问localhost:3001/set/user可以设置cookie")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// 7.2  cookie的key是jid，值是通过server.keys加密{name:"taopoppy",age: 18}这个对象的结果：比如155dew51re51vw1erw55gw-Udklsjsg-wdfjg12fd94')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// 7.3 session在redis存储的的key就是155dew51re51vw1erw55gw-Udklsjsg-wdfjg12fd94，value是"{\\"user\\"：{\\"name\\":\\"taopoppy\\",\\"age\\": 18,\\"_exprie\\":155505366755,\\"_maxAge\\":86400000}"')]),t._v("\n\trouter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/set/user'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"taopoppy"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'set session success'")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 8. 通过访问localhost:3001/delete/user可以删除cookie")]),t._v("\n\trouter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/delete/user'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("session "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置为null为自动将之前保存的和session相关的数据从redis中删除掉")]),t._v("\n\t\tctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'destroy session success'")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("img",{attrs:{src:t.$withBase("/react_ssr_cookie_session.png"),alt:"cookie_session"}}),t._v(" "),a("p",[t._v("可以看到当通过"),a("code",[t._v("ctx.session.xxx=yyy")]),t._v("设置的时候，服务端会自动在"),a("code",[t._v("ctx.body")]),t._v("的返回值中给浏览器种植"),a("code",[t._v("cookie")])]),t._v(" "),a("h2",{attrs:{id:"github-oauth接入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#github-oauth接入","aria-hidden":"true"}},[t._v("#")]),t._v(" Github OAuth接入")]),t._v(" "),a("p",[t._v("接下来我们就要正式将其接入，我们分几步去具体实现：")]),t._v(" "),a("h3",{attrs:{id:"_1-创建第三方登录链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建第三方登录链接","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 创建第三方登录链接")]),t._v(" "),a("p",[t._v("因为第三方授权的跳转实际上是链接的跳转，我们必须先去拼接一个我们需要的链接：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// next.config.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" withCss "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@zeit/next-css'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" config "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./config.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  1. 引入config，包含client_id和client_server")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" require "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'undefined'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\trequire"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("extensions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.css'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("file")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. github授权链接的根地址")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GITHUB_OAUTH_URL")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://github.com/login/oauth/authorize'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 定义权限(当前只需要user，后续可以写成'user,repo,gits')")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SCOPE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user'")]),t._v("\n\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("withCss")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 4. 在这里写所有的配置项，publicRuntimeConfig可以在客户度和服务端同时拿到")]),t._v("\n\tpublicRuntimeConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GITHUB_OAUTH_URL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("OAUTH_URL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("GITHUB_OAUTH_URL")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("?client_id=")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("github"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("client_id"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("&scope=")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SCOPE")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("`")])]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("然后我们有了自己拼接的链接，显示在页面上即可")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// pages/index.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" getConfig "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'next/config'")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 引入getConfig")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" publicRuntimeConfig "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 拿到publicRuntimeConfig")]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("Index")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("counter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("rename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("addcount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("a href"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("publicRuntimeConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("OAUTH_URL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("去登录"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 3. 显示到页面上*/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("这样当我们点击登录的链接，就会去"),a("code",[t._v("github")]),t._v("上面授权，不过授权完毕后跳转回来的是"),a("code",[t._v("http://localhost:3001/auth?code=5b5c56d8d1ee54eb6327")]),t._v("，这个地址我们是没有的，我们需要去创建这样一个路由")]),t._v(" "),a("h3",{attrs:{id:"_2-创建路由"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-创建路由","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. 创建路由")]),t._v(" "),a("p",[t._v("创建一个"),a("code",[t._v("/auth")]),t._v("的路由来处理授权之后"),a("code",[t._v("github")]),t._v("跳转来的的地址，当然我们先下载个东西：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("yarn add axios@"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.18")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),t._v("\n")])])]),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// server/auth.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" axios "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'axios'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" config "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'../config.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" client_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" client_secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("request_token_url "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("github\n\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("exports")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/auth'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果是localhost:3001/auth就处理")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("code\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'code not exist'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// code如果存在就要去根据code和client_id、client_secret去请求github生成tokne")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("axios")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        method"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'POST'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" request_token_url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          client_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          client_secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          code\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        headers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Accept'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/json'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 判断请求token是否成功")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果code二次使用，github也会返回200，所以要排除这种情况")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("githubAuth "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 拿到token我们就用token去请求一下用户信息")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("token_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" access_token "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" userInfoResp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("axios")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          method"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GET'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://api.github.com/user'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          headers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Authorization'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("token_type"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(" ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("access_token"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("`")])]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// console.log(userInfoResp.data)")]),t._v("\n\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将用户信息保存在session当中")]),t._v("\n        ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("userInfo "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" userInfoResp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data\n\n\n        ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("redirect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" errorMsg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("error\n        ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v("`request token failed ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("`")])]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 其他不是/auth不经过这层处理")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("有了这样一个函数之后，"),a("code",[t._v("http://localhost:3001/auth?code=5b5c56d8d1ee54eb6327")]),t._v("这个地址的访问就会经过上面这个中间件，并且结合"),a("code",[t._v("code")]),t._v("以及"),a("code",[t._v("clien_secret")]),t._v("和"),a("code",[t._v("client_id")]),t._v("到"),a("code",[t._v("github")]),t._v("服务器请求到"),a("code",[t._v("token")]),t._v("，我们使用该"),a("code",[t._v("token")]),t._v("获取了用户的信息，并直接保存在"),a("code",[t._v("redis")]),t._v("当中，我们到"),a("code",[t._v("server.js")]),t._v("当中去使用一下：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// nextjs-project/server.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" auth "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./server/auth.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 引入auth")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("prepare")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\tserver"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("session")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SESSION_CONFIG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 配置github OAuth登录，其auth函数必须在session后面")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("auth")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 编写测试路由")]),t._v("\n\trouter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/api/user/info'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 4. 直接从redis当中取出用户信息返回")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" user "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("userInfo\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("401")]),t._v("\n\t\t\tctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Need Login'")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user\n\t\t\tctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/json'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n")])])]),a("p",[t._v("然后我们到"),a("code",[t._v("pages/index.js")]),t._v("当中去测试一下这个路由")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// pages/index.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" useEffect "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'react'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 引入useEffect这个钩子")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" axios "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'axios'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 引入axios")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("Index")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("counter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("rename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("addcount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 进入组件")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果在没有登录的情况下请求localhost:3001/api/user/info是请求不成功的")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果在登录的情况下请求localhost:3001/api/user/info是成功的")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("useEffect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\taxios"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/api/user/info'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resp")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),a("p",[t._v("所以当我们没有登录，访问"),a("code",[t._v("localhost:3001/")]),t._v("就请求不到用户信息，因为"),a("code",[t._v("redis")]),t._v("当中没有，登录之后，回到首页"),a("code",[t._v("localhost:3001")]),t._v("，则就会在控制台当中打印出用户信息，到这里为止，整个"),a("code",[t._v("Github OAuth")]),t._v("就算接入完成了。")]),t._v(" "),a("p",[t._v("当然，使用用户信息并没有这么简单，而是要走服务端的流程，并且一开始用户信息就存在，我们就应该放在"),a("code",[t._v("redux")]),t._v("当中去。")])])},[],!1,null,null,null);s.default=e.exports}}]);